<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPO Dashboard - Placement Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <a href="/" class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>TPO Dashboard</span>
        </a>
        <div class="d-flex align-center gap-2">
            <a href="{{ url_for('leaderboard_page') }}" class="btn btn-secondary btn-sm"><i class="fas fa-trophy"></i>
                Leaderboard</a>
            <span style="color: var(--text-secondary); margin-right: 15px;">Welcome, {{ session.name }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-sm">Logout</a>
        </div>
    </nav>

    <div class="container-fluid">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert {{ 'alert-error' if category == 'error' else 'alert-success' }}">
            <i class="fas {{ 'fa-exclamation-circle' if category == 'error' else 'fa-check-circle' }}"></i> {{ message
            }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Stats Grid -->
        <div class="grid-3 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
            <div class="card stat-card">
                <div class="stat-icon" style="color: var(--primary);">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <div class="stat-value">{{ total_students }}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Students</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon" style="color: var(--info);">
                    <i class="fas fa-building"></i>
                </div>
                <div>
                    <div class="stat-value">{{ total_drives }}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Drives</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon" style="color: var(--success);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ active_drives }}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Drives</div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="stat-icon" style="color: var(--warning);">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <div class="stat-value">{{ selected_count }}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">Selected</div>
                </div>
            </div>
        </div>

        <!-- ðŸ“Š Analytics Charts Row -->
        <div class="row mb-4" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-pie" style="color: var(--accent);"></i> Application
                        Status</div>
                </div>
                <div style="height: 300px; position: relative;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><i class="fas fa-chart-bar" style="color: var(--info);"></i> Placements by
                        Dept</div>
                </div>
                <div style="height: 300px; position: relative;">
                    <canvas id="deptChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Chart.js Library -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Prepare Data
                const statusData = {{ status_stats | tojson
            }};
            const deptData = {{ dept_stats | tojson }};

            // 1. Status Chart (Pie)
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: statusData.map(d => d.status),
                    datasets: [{
                        data: statusData.map(d => d.count),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'], // Blue, Green, Yellow, Red
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } }
                    }
                }
            });

            // 2. Dept Chart (Bar)
            const ctxDept = document.getElementById('deptChart').getContext('2d');
            new Chart(ctxDept, {
                type: 'bar',
                data: {
                    labels: deptData.map(d => d.department || 'Unknown'),
                    datasets: [{
                        label: 'Students Placed',
                        data: deptData.map(d => d.count),
                        backgroundColor: '#00d4ff',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            });
        </script>

        <div class="dashboard-layout" style="grid-template-columns: 1fr 350px;">
            <!-- Left Column: Pending Actions / Tables -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">

                <!-- Applications Management -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-list-check" style="color: var(--success);"></i> Applications Management
                        </div>
                    </div>
                    {% if applications %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Company</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Mock Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for app in applications %}
                                <tr>
                                    <td>
                                        <div style="font-weight: 600;">{{ app.student_name }}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ app.email }}
                                        </div>
                                    </td>
                                    <td>{{ app.company_name }}</td>
                                    <td>{{ app.job_role }}</td>
                                    <td>
                                        <span
                                            class="badge badge-{{ 'success' if app.status == 'Selected' else 'info' if app.status == 'Shortlisted' else 'warning' if app.status == 'Applied' else 'danger' }}">
                                            {{ app.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if app.mock_test_score is not none %}
                                        <span class="badge badge-info">{{ app.mock_test_score }}/5</span>
                                        {% else %}
                                        <span style="color: var(--text-muted); font-size: 0.8rem;">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            <button onclick="openStatusModal({{ app.id }}, '{{ app.status }}')"
                                                class="btn btn-secondary btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if app.status == 'Selected' %}
                                            <button onclick="openOfferModal({{ app.id }})"
                                                class="btn btn-success btn-sm">
                                                <i class="fas fa-file-contract"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center p-4">
                        <p class="text-secondary">No applications yet.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Recent Drives List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history" style="color: var(--info);"></i> Recent Drives
                        </div>
                    </div>
                    {% if drives %}
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Role</th>
                                    <th>Depts</th>
                                    <th>Vacancies</th>
                                    <th>Last Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for drive in drives %}
                                <tr>
                                    <td style="font-weight: 600;">{{ drive.company_name }}</td>
                                    <td>{{ drive.job_role }}</td>
                                    <td><span class="badge badge-info">{{ drive.departments or 'All' }}</span></td>
                                    <td>{{ drive.vacancy_count or 'âˆž' }}</td>
                                    <td>{{ drive.last_date }}</td>
                                    <td>
                                        <span
                                            class="badge badge-{{ 'success' if drive.status == 'active' else 'secondary' }}">
                                            {{ drive.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center p-4">
                        <p class="text-secondary">No drives created yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column: Create Drive & Export -->
            <div style="display: flex; flex-direction: column; gap: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-plus-circle" style="color: var(--primary);"></i> Create Drive
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('create_drive') }}">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="company_name" required
                                placeholder="e.g. Google">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Role</label>
                            <input type="text" class="form-control" name="job_role" required placeholder="e.g. SDE I">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Description</label>
                            <textarea class="form-control" name="job_description" rows="3"
                                placeholder="Key responsibilities..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Departments</label>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                <label><input type="checkbox" name="departments" value="CS"> CS</label>
                                <label><input type="checkbox" name="departments" value="IS"> IS</label>
                                <label><input type="checkbox" name="departments" value="EC"> EC</label>
                                <label><input type="checkbox" name="departments" value="EEE"> EEE</label>
                                <label><input type="checkbox" name="departments" value="MCA"> MCA</label>
                                <label><input type="checkbox" name="departments" value="MBA"> MBA</label>
                                <label><input type="checkbox" name="departments" value="MTECH"> MTECH</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vacancy Count</label>
                            <input type="number" class="form-control" name="vacancy_count" min="1"
                                placeholder="e.g. 10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Eligibility Criteria</label>
                            <input type="text" class="form-control" name="eligibility" placeholder="e.g. CGPA > 8.0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Date</label>
                            <input type="date" class="form-control" name="last_date" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            Create Drive
                        </button>
                    </form>
                </div>

                <div class="card text-center">
                    <div class="card-header">
                        <div class="card-title justify-content-center">Reports</div>
                    </div>
                    <p class="text-secondary mb-4">Export complete placement data for analysis.</p>
                    <a href="{{ url_for('export_tpo_report') }}" class="btn btn-primary w-100">
                        <i class="fas fa-download"></i> Export Excel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="card" style="width: 90%; max-width: 400px;">
            <div class="d-flex justify-between align-center mb-4">
                <h3 class="card-title">Update Status</h3>
                <button onclick="closeModal('statusModal')" class="btn btn-secondary"
                    style="border: none; font-size: 1.5rem;">&times;</button>
            </div>
            <form id="statusForm" method="POST">
                <div class="form-group">
                    <label class="form-label">Application Status</label>
                    <select class="form-control" name="status" id="statusSelect" required>
                        <option value="Applied">Applied</option>
                        <option value="Shortlisted">Shortlisted</option>
                        <option value="Selected">Selected</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="d-flex justify-between gap-2">
                    <button type="button" onclick="closeModal('statusModal')"
                        class="btn btn-secondary w-100">Cancel</button>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Offer Upload Modal -->
    <div id="offerModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="card" style="width: 90%; max-width: 400px;">
            <div class="d-flex justify-between align-center mb-4">
                <h3 class="card-title">Upload Offer Letter</h3>
                <button onclick="closeModal('offerModal')" class="btn btn-secondary"
                    style="border: none; font-size: 1.5rem;">&times;</button>
            </div>
            <form id="offerForm" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="form-label">Select File (PDF/DOCX)</label>
                    <input type="file" class="form-control" name="offer_letter" accept=".pdf,.docx,.doc" required>
                </div>
                <div class="d-flex justify-between gap-2">
                    <button type="button" onclick="closeModal('offerModal')"
                        class="btn btn-secondary w-100">Cancel</button>
                    <button type="submit" class="btn btn-success w-100">Upload & Send</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openStatusModal(appId, currentStatus) {
            const modal = document.getElementById('statusModal');
            const form = document.getElementById('statusForm');
            const select = document.getElementById('statusSelect');

            form.action = `/tpo/update_application_status/${appId}`;
            select.value = currentStatus;
            modal.style.display = 'flex';
        }

        function openOfferModal(appId) {
            const modal = document.getElementById('offerModal');
            const form = document.getElementById('offerForm');

            form.action = `/tpo/upload_offer_letter/${appId}`;
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close on outside click
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay') || event.target.id.includes('Modal')) {
                if (event.target.id) closeModal(event.target.id);
            }
        }
    </script>
</body>

</html>